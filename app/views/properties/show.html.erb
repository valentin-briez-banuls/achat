<% content_for(:title, @property.title) %>
<% prop = @property.decorate %>

<div class="max-w-5xl mx-auto space-y-6">
  <!-- Header -->
  <div class="flex flex-wrap items-start justify-between gap-3">
    <div class="min-w-0 flex-1">
      <div class="flex flex-wrap items-center gap-2">
        <h1 class="text-xl sm:text-2xl font-bold text-gray-900"><%= prop.title %></h1>
        <%= prop.status_badge %>
      </div>
      <p class="mt-1 text-sm text-gray-500 truncate"><%= prop.location %> &middot; <%= prop.type_label %> &middot; <%= prop.condition_label %></p>
    </div>
    <div class="flex flex-wrap items-center gap-2 shrink-0">
      <%= link_to "Modifier", edit_property_path(@property), class: "rounded-lg bg-gray-100 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200" %>
      <%= link_to "Négocier", property_negotiation_path(@property), class: "rounded-lg bg-indigo-50 px-3 py-2 text-sm font-medium text-indigo-700 hover:bg-indigo-100" %>
      <%= link_to "Simuler", new_property_simulation_path(@property), class: "rounded-lg bg-blue-600 px-3 py-2 text-sm font-medium text-white hover:bg-blue-500" %>
    </div>
  </div>

  <!-- Photos -->
  <% if @property.photos.attached? || @property.parsed_image_urls.any? %>
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 rounded-xl overflow-hidden">
      <% if @property.photos.attached? %>
        <% @property.photos.each do |photo| %>
          <%= image_tag photo.variant(resize_to_fill: [400, 300]), class: "w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity" %>
        <% end %>
      <% else %>
        <% @property.parsed_image_urls.each do |img_url| %>
          <%= image_tag img_url, class: "w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity", loading: "lazy", onerror: "this.style.display='none'" %>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
    <!-- Main Info -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Price & Stats -->
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
          <div>
            <p class="text-xs text-gray-500">Prix</p>
            <p class="text-xl font-bold text-gray-900"><%= prop.formatted_price %></p>
            <% if @property.price_dropped? %>
              <span class="inline-flex items-center gap-0.5 text-xs font-medium text-amber-700 mt-0.5">
                ↓ -<%= @property.price_drop_percentage %>% depuis la mise en ligne
              </span>
            <% end %>
          </div>
          <div><p class="text-xs text-gray-500">Surface</p><p class="text-xl font-bold text-gray-900"><%= prop.formatted_surface %></p></div>
          <div><p class="text-xs text-gray-500">Prix/m²</p><p class="text-xl font-bold text-gray-900"><%= prop.formatted_price_per_sqm %></p></div>
          <div><p class="text-xs text-gray-500">Chambres</p><p class="text-xl font-bold text-gray-900"><%= @property.bedrooms || "—" %></p></div>
        </div>
      </div>

      <!-- Price History -->
      <% if @price_history.size >= 2 %>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Historique des prix</h3>
          <%= line_chart @price_history.map { |h| [h.scraped_at.strftime("%d/%m/%Y"), h.price] },
              height: "150px", suffix: " €", colors: ["#f59e0b"],
              library: { scales: { y: { ticks: { callback: nil } } } } %>
        </div>
      <% end %>

      <!-- Financial Details -->
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-4">Détails financiers</h3>
        <dl class="grid grid-cols-2 gap-4">
          <div><dt class="text-xs text-gray-500">Frais d'agence</dt><dd class="text-sm font-medium"><%= currency(@property.agency_fees) %> <%= "(inclus)" if @property.agency_fees_included? %></dd></div>
          <div><dt class="text-xs text-gray-500">Charges copro</dt><dd class="text-sm font-medium"><%= currency(@property.copro_charges_monthly) %>/mois</dd></div>
          <div><dt class="text-xs text-gray-500">Taxe foncière</dt><dd class="text-sm font-medium"><%= currency(@property.property_tax_yearly) %>/an</dd></div>
          <div><dt class="text-xs text-gray-500">Travaux estimés</dt><dd class="text-sm font-medium"><%= currency(@property.estimated_works) %></dd></div>
        </dl>
      </div>

      <!-- Frais de notaire -->
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-semibold text-gray-900">Frais de notaire estimés</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            ~<%= @notary_fees[:percentage] %>% du prix
          </span>
        </div>
        <div class="text-center mb-4">
          <p class="text-2xl font-bold text-gray-900"><%= currency(@notary_fees[:total]) %></p>
          <p class="text-xs text-gray-500 mt-1">sur un prix effectif de <%= currency(@property.effective_price) %></p>
        </div>
        <dl class="space-y-2 border-t border-gray-100 pt-3">
          <div class="flex justify-between text-sm">
            <dt class="text-gray-500">Droits de mutation</dt>
            <dd class="font-medium"><%= currency(@notary_fees[:droits_mutation]) %></dd>
          </div>
          <div class="flex justify-between text-sm">
            <dt class="text-gray-500">Émoluments notaire</dt>
            <dd class="font-medium"><%= currency(@notary_fees[:emoluments]) %></dd>
          </div>
          <div class="flex justify-between text-sm">
            <dt class="text-gray-500">Contribution sécurité</dt>
            <dd class="font-medium"><%= currency(@notary_fees[:contribution_securite]) %></dd>
          </div>
          <div class="flex justify-between text-sm">
            <dt class="text-gray-500">Débours</dt>
            <dd class="font-medium"><%= currency(@notary_fees[:debours]) %></dd>
          </div>
        </dl>
      </div>

      <!-- Characteristics -->
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-4">Caractéristiques</h3>
        <div class="flex flex-wrap gap-2">
          <%= prop.energy_badge %>
          <% if @property.ges_class %>
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700">GES <%= @property.ges_class %></span>
          <% end %>
          <% if @property.has_outdoor? %>
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-50 text-green-700">Extérieur</span>
          <% end %>
          <% if @property.has_parking? %>
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-50 text-green-700">Parking</span>
          <% end %>
          <% if @property.floor %>
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700">Étage <%= @property.floor %></span>
          <% end %>
        </div>
      </div>

      <!-- Simulations -->
      <% if @simulations.any? %>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-semibold text-gray-900">Simulations</h3>
            <%= link_to "Nouvelle simulation", new_property_simulation_path(@property), class: "text-sm text-blue-600 hover:text-blue-500" %>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead><tr>
                <th class="text-left text-xs font-medium text-gray-500 pb-2">Nom</th>
                <th class="text-right text-xs font-medium text-gray-500 pb-2">Mensualité</th>
                <th class="text-right text-xs font-medium text-gray-500 pb-2 hidden sm:table-cell">Endettement</th>
                <th class="text-right text-xs font-medium text-gray-500 pb-2 hidden md:table-cell">Coût total</th>
                <th class="text-center text-xs font-medium text-gray-500 pb-2 hidden sm:table-cell">PTZ</th>
              </tr></thead>
              <tbody class="divide-y divide-gray-100">
                <% @simulations.each do |sim| %>
                  <% s = sim.decorate %>
                  <tr class="hover:bg-gray-50">
                    <td class="py-2"><%= link_to(sim.name || "Simulation", property_simulation_path(@property, sim), class: "text-sm text-blue-600 hover:underline") %></td>
                    <td class="py-2 text-right text-sm font-medium"><%= s.formatted_total_monthly %></td>
                    <td class="py-2 text-right hidden sm:table-cell"><%= s.debt_ratio_badge %></td>
                    <td class="py-2 text-right text-sm hidden md:table-cell"><%= s.formatted_total_credit_cost %></td>
                    <td class="py-2 text-center hidden sm:table-cell"><%= s.ptz_badge %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>

      <!-- Notes -->
      <% if @property.personal_notes.present? %>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-2">Notes</h3>
          <p class="text-sm text-gray-700 whitespace-pre-line"><%= @property.personal_notes %></p>
        </div>
      <% end %>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Score -->
      <% if @score %>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-3">Score de compatibilité</h3>
          <div class="text-center mb-4">
            <span class="text-4xl font-bold text-gray-900"><%= @score.total_score %></span><span class="text-lg text-gray-400">/100</span>
            <div class="mt-2"><%= render "shared/traffic_light", light: @score.traffic_light %></div>
          </div>
          <div class="space-y-2">
            <% { budget_score: "Budget", surface_score: "Surface", bedrooms_score: "Chambres", energy_score: "DPE", location_score: "Localisation", neighborhood_score: "Quartier", view_score: "Vue", orientation_score: "Exposition", quietness_score: "Calme", brightness_score: "Luminosité" }.each do |field, label| %>
              <% val = @score.send(field) %>
              <div>
                <div class="flex justify-between text-xs mb-0.5"><span class="text-gray-500"><%= label %></span><span class="font-medium"><%= val %></span></div>
                <div class="w-full bg-gray-100 rounded-full h-1.5">
                  <% bar_color = val >= 75 ? "bg-green-500" : val >= 45 ? "bg-yellow-400" : "bg-red-500" %>
                  <div class="<%= bar_color %> h-1.5 rounded-full" style="width: <%= val %>%"></div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Actions -->
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6 space-y-3">
        <h3 class="text-sm font-semibold text-gray-900 mb-2">Actions</h3>
        <%= link_to "Planifier une visite", new_property_visit_path(@property), class: "block w-full text-center rounded-lg bg-blue-50 px-3 py-2 text-sm font-medium text-blue-700 hover:bg-blue-100" %>
        <%= link_to "Simuler la négociation", property_negotiation_path(@property), class: "block w-full text-center rounded-lg bg-indigo-50 px-3 py-2 text-sm font-medium text-indigo-700 hover:bg-indigo-100" %>
        <%= link_to "Faire une offre", new_property_offer_path(@property), class: "block w-full text-center rounded-lg bg-green-50 px-3 py-2 text-sm font-medium text-green-700 hover:bg-green-100" %>
        <% if @property.listing_url.present? %>
          <%= link_to "Voir l'annonce", @property.listing_url, target: "_blank", rel: "noopener", class: "block w-full text-center rounded-lg bg-gray-50 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100" %>
        <% end %>
        <%= link_to "Supprimer", property_path(@property), data: { turbo_method: :delete, turbo_confirm: "Supprimer ce bien ?" }, class: "block w-full text-center rounded-lg bg-red-50 px-3 py-2 text-sm font-medium text-red-700 hover:bg-red-100" %>
      </div>

      <!-- Visits -->
      <% if @visits.any? %>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-3">Visites</h3>
          <ul class="space-y-2">
            <% @visits.each do |visit| %>
              <li class="text-sm flex justify-between">
                <span class="text-gray-600"><%= l(visit.scheduled_at, format: :short) %></span>
                <span class="font-medium"><%= visit.status.humanize %></span>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Offers -->
      <% if @offers.any? %>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-3">Offres</h3>
          <ul class="space-y-2">
            <% @offers.each do |offer| %>
              <li class="text-sm flex justify-between">
                <%= link_to currency(offer.amount), property_offer_path(@property, offer), class: "text-blue-600 hover:underline" %>
                <span class="font-medium"><%= offer.status.humanize %></span>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>
  </div>
</div>
