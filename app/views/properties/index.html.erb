<% content_for(:title, "Biens immobiliers") %>

<div class="space-y-6">
  <div class="flex flex-wrap items-start justify-between gap-3">
    <div class="min-w-0">
      <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Biens immobiliers</h1>
      <p class="mt-1 text-sm text-gray-500"><%= @properties.size %> bien(s)</p>
    </div>
    <div class="flex flex-wrap items-center gap-2 shrink-0">
      <%= form_tag comparison_path, method: :get, id: "compare-form" do %>
        <button type="submit" class="inline-flex items-center gap-x-1.5 rounded-lg bg-gray-100 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200" data-controller="comparison" data-action="click->comparison#submit">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
          <span class="hidden sm:inline">Comparer</span>
        </button>
      <% end %>
      <%= link_to new_property_path, class: "inline-flex items-center gap-x-1.5 rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        Ajouter
      <% end %>
    </div>
  </div>

  <!-- Status Tabs -->
  <div class="flex gap-2 flex-wrap">
    <%= link_to "Tous", properties_path(request.query_parameters.except("status")), class: "rounded-lg px-3 py-1.5 text-sm font-medium #{params[:status].blank? ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}" %>
    <% Property.statuses.keys.each do |s| %>
      <% label = { "a_analyser" => "À analyser", "a_visiter" => "À visiter", "visite" => "Visité", "offre_faite" => "Offre faite", "refuse" => "Refusé", "accepte" => "Accepté" }[s] %>
      <%= link_to label, properties_path(request.query_parameters.merge(status: s)), class: "rounded-lg px-3 py-1.5 text-sm font-medium #{params[:status] == s ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}" %>
    <% end %>
  </div>

  <!-- Filters -->
  <div data-controller="filters" class="bg-white rounded-xl border border-gray-100 shadow-sm">
    <button type="button" data-action="click->filters#toggle" class="w-full flex items-center justify-between px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-xl">
      <span class="flex items-center gap-2">
        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
        Filtres
        <% active_filters = [:property_type, :city, :min_price, :max_price, :min_surface, :max_surface, :min_bedrooms, :energy_class, :sort].count { |f| params[f].present? } %>
        <% if active_filters > 0 %>
          <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-blue-600 rounded-full"><%= active_filters %></span>
        <% end %>
      </span>
      <svg data-filters-target="icon" class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
    </button>

    <div data-filters-target="panel" class="<%= active_filters > 0 ? '' : 'hidden' %> border-t border-gray-100 px-4 py-4">
      <%= form_tag properties_path, method: :get, class: "space-y-4" do %>
        <%# Conserver le filtre de statut actif %>
        <% if params[:status].present? %>
          <input type="hidden" name="status" value="<%= params[:status] %>">
        <% end %>

        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
          <%# Type de bien %>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">Type</label>
            <select name="property_type" class="w-full rounded-lg border-gray-200 text-sm py-1.5 focus:border-blue-500 focus:ring-blue-500">
              <option value="">Tous</option>
              <% { "appartement" => "Appartement", "maison" => "Maison", "terrain" => "Terrain", "loft" => "Loft", "duplex" => "Duplex" }.each do |val, label| %>
                <option value="<%= val %>" <%= "selected" if params[:property_type] == val %>><%= label %></option>
              <% end %>
            </select>
          </div>

          <%# Ville %>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">Ville</label>
            <input type="text" name="city" value="<%= params[:city] %>" placeholder="Ex: Paris" class="w-full rounded-lg border-gray-200 text-sm py-1.5 focus:border-blue-500 focus:ring-blue-500">
          </div>

          <%# Prix min %>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">Prix min</label>
            <input type="number" name="min_price" value="<%= params[:min_price] %>" placeholder="0 €" step="10000" min="0" class="w-full rounded-lg border-gray-200 text-sm py-1.5 focus:border-blue-500 focus:ring-blue-500">
          </div>

          <%# Prix max %>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">Prix max</label>
            <input type="number" name="max_price" value="<%= params[:max_price] %>" placeholder="Illimité" step="10000" min="0" class="w-full rounded-lg border-gray-200 text-sm py-1.5 focus:border-blue-500 focus:ring-blue-500">
          </div>

          <%# Surface min %>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">Surface min</label>
            <input type="number" name="min_surface" value="<%= params[:min_surface] %>" placeholder="0 m²" step="5" min="0" class="w-full rounded-lg border-gray-200 text-sm py-1.5 focus:border-blue-500 focus:ring-blue-500">
          </div>

          <%# Surface max %>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">Surface max</label>
            <input type="number" name="max_surface" value="<%= params[:max_surface] %>" placeholder="Illimité" step="5" min="0" class="w-full rounded-lg border-gray-200 text-sm py-1.5 focus:border-blue-500 focus:ring-blue-500">
          </div>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
          <%# Chambres min %>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">Chambres min</label>
            <select name="min_bedrooms" class="w-full rounded-lg border-gray-200 text-sm py-1.5 focus:border-blue-500 focus:ring-blue-500">
              <option value="">--</option>
              <% (1..6).each do |n| %>
                <option value="<%= n %>" <%= "selected" if params[:min_bedrooms] == n.to_s %>><%= n %>+</option>
              <% end %>
            </select>
          </div>

          <%# DPE %>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">DPE max</label>
            <select name="energy_class" class="w-full rounded-lg border-gray-200 text-sm py-1.5 focus:border-blue-500 focus:ring-blue-500">
              <option value="">Tous</option>
              <% Property::ENERGY_CLASSES.each do |ec| %>
                <option value="<%= ec %>" <%= "selected" if params[:energy_class] == ec %>><%= ec %></option>
              <% end %>
            </select>
          </div>

          <%# Tri %>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">Trier par</label>
            <select name="sort" class="w-full rounded-lg border-gray-200 text-sm py-1.5 focus:border-blue-500 focus:ring-blue-500">
              <% { "" => "Plus récent", "price_asc" => "Prix croissant", "price_desc" => "Prix décroissant", "surface_desc" => "Surface", "score_desc" => "Score" }.each do |val, label| %>
                <option value="<%= val %>" <%= "selected" if params[:sort] == val %>><%= label %></option>
              <% end %>
            </select>
          </div>

          <%# Boutons %>
          <div class="flex items-end gap-2 lg:col-span-3">
            <button type="submit" class="rounded-lg bg-blue-600 px-4 py-1.5 text-sm font-medium text-white hover:bg-blue-500">
              Appliquer
            </button>
            <%= link_to "Réinitialiser", properties_path(status: params[:status].presence), class: "rounded-lg bg-gray-100 px-4 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-200" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Properties Grid -->
  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
    <% @properties.each do |property| %>
      <%= render "card", property: property %>
    <% end %>
  </div>

  <% if @properties.empty? %>
    <div class="text-center py-12">
      <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9zm3.75 11.625a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg>
      <p class="mt-2 text-sm text-gray-500">Aucun bien ne correspond aux filtres.</p>
    </div>
  <% end %>

  <!-- Pagination -->
  <div class="flex justify-center">
    <%# TODO: Réactiver une fois pagy configuré pour Pagy 9+ %>
    <%#== pagy_nav(@pagy) if @pagy.pages > 1 %>
  </div>
</div>
