<% content_for(:title, "Dashboard - Achat") %>

<div class="space-y-8">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Tableau de bord</h1>
      <p class="mt-1 text-sm text-gray-500">Vue synthétique de votre projet immobilier</p>
    </div>
    <% if current_household %>
      <%= link_to new_property_path, class: "inline-flex items-center gap-x-1.5 rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        Ajouter un bien
      <% end %>
    <% end %>
  </div>

  <% unless current_household %>
    <div class="rounded-xl bg-blue-50 border border-blue-200 p-6 text-center">
      <h3 class="text-lg font-semibold text-blue-900">Bienvenue sur Achat !</h3>
      <p class="mt-2 text-sm text-blue-700">Commencez par créer votre foyer pour accéder à toutes les fonctionnalités.</p>
      <%= link_to "Créer mon foyer", new_household_path, class: "mt-4 inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-500" %>
    </div>
  <% else %>

    <% if @financial_profile && @finance_data %>
      <!-- KPI Cards -->
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <%= render "shared/financial_indicator",
            label: "Capacité d'emprunt",
            value: currency(@finance_data[:borrowing_capacity]),
            color: "blue",
            icon_path: "M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z",
            subtitle: "Durée : #{@financial_profile.desired_duration_years} ans à #{@financial_profile.proposed_rate}%" %>

        <%= render "shared/financial_indicator",
            label: "Budget optimal",
            value: currency(@finance_data[:optimal_budget]),
            color: "green",
            icon_path: "M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
            subtitle: "Apport inclus : #{currency(@financial_profile.personal_contribution)}" %>

        <%= render "shared/financial_indicator",
            label: "Mensualité max",
            value: currency(@finance_data[:max_monthly_payment]),
            color: "yellow",
            icon_path: "M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5",
            subtitle: "35% des revenus (norme HCSF)" %>

        <%= render "shared/financial_indicator",
            label: "Reste à vivre",
            value: currency(@finance_data[:remaining_to_live]),
            color: @finance_data[:remaining_to_live].to_f > 1000 ? "green" : "red",
            icon_path: "M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" %>
      </div>

      <!-- Danger Indicators -->
      <% if @finance_data[:danger_indicators].any? %>
        <div class="rounded-xl border border-red-200 bg-red-50 p-4">
          <h3 class="text-sm font-semibold text-red-800 mb-2">Alertes</h3>
          <ul class="space-y-1">
            <% @finance_data[:danger_indicators].each do |indicator| %>
              <% icon_color = { critical: "text-red-500", warning: "text-yellow-500", info: "text-blue-500" }[indicator[:level]] %>
              <li class="flex items-center gap-2 text-sm text-gray-700">
                <span class="w-2 h-2 rounded-full <%= icon_color.gsub('text-', 'bg-') %>"></span>
                <%= indicator[:message] %>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    <% else %>
      <div class="rounded-xl bg-yellow-50 border border-yellow-200 p-6 text-center">
        <p class="text-sm text-yellow-800">Complétez votre profil financier pour voir vos indicateurs.</p>
        <%= link_to "Compléter le profil", new_financial_profile_path, class: "mt-3 inline-flex items-center rounded-lg bg-yellow-600 px-4 py-2 text-sm font-semibold text-white hover:bg-yellow-500" %>
      </div>
    <% end %>

    <!-- Charts Row -->
    <% if @properties.any? %>
      <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <!-- Scores Chart -->
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Score de compatibilité</h3>
          <% if @scores_data.any? %>
            <%= bar_chart @scores_data, colors: ["#3b82f6"], height: "250px", library: { scales: { y: { max: 100 } } } %>
          <% else %>
            <p class="text-sm text-gray-500">Aucun score calculé pour le moment.</p>
          <% end %>
        </div>

        <!-- Monthly Payments Chart -->
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Mensualités comparées</h3>
          <% if @monthly_payments_data.any? %>
            <%= bar_chart @monthly_payments_data, colors: ["#10b981"], height: "250px", prefix: "", suffix: " €" %>
          <% else %>
            <p class="text-sm text-gray-500">Lancez des simulations pour voir les mensualités.</p>
          <% end %>
        </div>
      </div>

      <!-- Debt Ratio Chart -->
      <% if @debt_ratio_data.any? %>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Impact sur le taux d'endettement</h3>
          <%= column_chart @debt_ratio_data, colors: ["#f59e0b"], height: "200px", suffix: "%",
              library: {
                plugins: {
                  annotation: {
                    annotations: {
                      line1: { type: "line", yMin: 35, yMax: 35, borderColor: "#ef4444", borderWidth: 2, label: { content: "Seuil HCSF 35%", display: true } }
                    }
                  }
                }
              } %>
        </div>
      <% end %>

      <!-- Properties List -->
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 class="text-sm font-semibold text-gray-900">Biens classés par score</h3>
          <%= link_to "Voir tous", properties_path, class: "text-sm text-blue-600 hover:text-blue-500" %>
        </div>
        <div class="divide-y divide-gray-100">
          <% @properties.each do |property| %>
            <% prop = property.decorate %>
            <div class="px-6 py-4 flex items-center justify-between hover:bg-gray-50">
              <div class="flex items-center gap-4 min-w-0">
                <%= prop.score_badge %>
                <div class="min-w-0">
                  <%= link_to prop.title, property, class: "text-sm font-medium text-gray-900 hover:text-blue-600 truncate block" %>
                  <p class="text-xs text-gray-500"><%= prop.location %> &middot; <%= prop.formatted_surface %></p>
                </div>
              </div>
              <div class="flex items-center gap-3 shrink-0">
                <%= prop.status_badge %>
                <span class="text-sm font-semibold text-gray-900"><%= prop.formatted_price %></span>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Upcoming Visits & Pending Offers -->
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
      <% if @upcoming_visits.any? %>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Prochaines visites</h3>
          <ul class="space-y-3">
            <% @upcoming_visits.each do |visit| %>
              <li class="flex items-center justify-between text-sm">
                <span class="text-gray-700"><%= visit.property.title.truncate(30) %></span>
                <span class="text-gray-500"><%= l(visit.scheduled_at, format: :short) %></span>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <% if @pending_offers.any? %>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Offres en cours</h3>
          <ul class="space-y-3">
            <% @pending_offers.each do |offer| %>
              <li class="flex items-center justify-between text-sm">
                <span class="text-gray-700"><%= offer.property.title.truncate(30) %></span>
                <span class="font-medium text-gray-900"><%= currency(offer.amount) %></span>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>

  <% end %>
</div>
